<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VSABrains Narrative Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Fraunces:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <div class="brand-mark">VSA</div>
          <div>
            <div class="brand-title">VSABrains</div>
            <div class="brand-subtitle">Narrative Trajectory Demo</div>
          </div>
          <a class="tutorial-link" href="tutorial.html">1000Brains tutorial</a>
        </div>
        <div class="topbar-actions">
          <div class="content-mode">
            <label for="contentMode">Content Mode</label>
            <select id="contentMode">
              <option value="synthetic">Synthetic</option>
              <option value="literature">Literature w/ Dialogue &amp; Intrigue</option>
              <option value="chat">Chat Dialog</option>
            </select>
          </div>
          <div class="action-menu">
            <label for="storyAction">Story Action</label>
            <div class="columns-row">
              <select id="storyAction">
                <option value="reset:consistent">Reset Clean Story (1,000)</option>
                <option value="reset:contradicting">Reset Contradicting Story (1,000)</option>
                <option value="append:consistent">Append 10,000 Clean Actions</option>
                <option value="append:contradicting">Append 10,000 Contradicting Actions</option>
              </select>
              <button class="btn primary" id="storyActionRun">Run</button>
            </div>
            <div class="columns-note">Reset replaces story; Append adds facts.</div>
          </div>
        </div>
      </header>

      <main class="grid simple">
        <section class="panel viz">
          <div class="viz-header">
            <h2>Memory Grid</h2>
            <div class="tab-row">
              <button class="tab-btn active" data-tab="grid">Grid</button>
              <button class="tab-btn" data-tab="story">Story &amp; Meta</button>
            </div>
          </div>
          <div class="canvas-wrap tab-panel" data-panel="grid">
            <canvas id="gridCanvas" width="520" height="520"></canvas>
          </div>
          <div class="grid-footer tab-panel" data-panel="grid">
            <div class="anim-controls">
              <div class="anim-buttons">
                <button class="icon-btn" id="animPlayBtn" title="Play">▶</button>
                <button class="icon-btn" id="animPauseBtn" title="Pause">❚❚</button>
                <button class="icon-btn" id="animNextBtn" title="Next step">⏭</button>
              </div>
              <div class="anim-speed">
                <label for="animSpeed">Animation Speed</label>
                <div class="columns-row">
                  <input type="range" id="animSpeed" min="0" max="100" step="1" value="50" />
                  <div class="columns-value" id="animSpeedValue">1.0x</div>
                </div>
                <div class="columns-note" id="animSpeedHint">≈ 2.2s per sweep</div>
              </div>
            </div>
            <div class="columns-footer">
              <div class="columns-control compact">
                <label for="columnsRange">Columns</label>
                <div class="columns-row">
                  <input type="range" id="columnsRange" min="1" max="9" step="1" value="3" />
                  <div class="columns-value" id="columnsValue">3</div>
                  <button class="btn ghost" id="applyColumnsBtn">Apply</button>
                </div>
                <div class="columns-note">Rebuilds the brain and replays the story.</div>
              </div>
              <div class="columns-filter" id="columnsFilter">
                <span>Show columns:</span>
                <div class="columns-checkboxes" id="columnsCheckboxes"></div>
                <div class="columns-actions">
                  <button class="btn ghost small" id="columnsAllBtn">All</button>
                  <button class="btn ghost small" id="columnsNoneBtn">None</button>
                </div>
              </div>
            </div>
          </div>
          <div class="story-block tab-panel hidden" data-panel="story">
            <label for="storyField">Story (Read-only)</label>
            <textarea id="storyField" rows="24" readonly></textarea>
          </div>
          <div class="grid-meta tab-panel hidden" data-panel="story">
            <span id="stepValue">Step 0</span>
            <span id="eventsMeta">Events: 0</span>
            <span id="columnsMeta">Columns: 3</span>
            <span id="contradictionsValue">Contradictions: 0</span>
          </div>
        </section>

        <section class="panel control">
          <h2>Control Panel</h2>
          <div class="subtab-row">
            <button class="subtab-btn active" data-subtab="query">Query</button>
            <button class="subtab-btn" data-subtab="cnl">CNL</button>
            <button class="subtab-btn" data-subtab="frames">Frames</button>
          </div>
          <div class="subtab-panel" data-subpanel="query">
          <p class="muted">Try at least 10 query types to explore reasoning and contradictions.</p>
          <div class="field">
            <label for="queryType">Query Type</label>
            <select id="queryType">
              <option value="where">Where is an entity (latest)?</option>
              <option value="whereAt">Where is an entity (at step)?</option>
              <option value="entitiesAt">Who is in a location?</option>
              <option value="inventory">What does an entity have?</option>
              <option value="whoHas">Who has an item?</option>
              <option value="itemLocation">Where is an item?</option>
              <option value="isAlive">Is an entity alive?</option>
              <option value="lastEvent">Last event for entity</option>
              <option value="timeline">Timeline for entity</option>
              <option value="contradictions">All contradictions</option>
              <option value="contradictionsFor">Contradictions for entity</option>
            </select>
          </div>

          <div class="field" id="queryEntityField">
            <label for="queryEntity">Entity</label>
            <select id="queryEntity"></select>
          </div>

          <div class="field" id="queryTargetField">
            <label for="queryTarget">Other Entity</label>
            <select id="queryTarget"></select>
          </div>

          <div class="field" id="queryItemField">
            <label for="queryItem">Item</label>
            <select id="queryItem"></select>
          </div>

          <div class="field" id="queryLocationField">
            <label for="queryLocation">Location</label>
            <select id="queryLocation"></select>
          </div>

          <div class="field" id="queryStepField">
            <label for="queryStep">Step</label>
            <input type="number" id="queryStep" min="0" placeholder="Latest" />
          </div>

          <div class="field" id="queryLimitField">
            <label for="queryLimit">Limit</label>
            <input type="number" id="queryLimit" min="1" value="6" />
          </div>

          <button class="btn primary" id="runQueryBtn">Run Query</button>

          <div class="story-block">
            <label for="queryAnswer">Answer</label>
            <textarea id="queryAnswer" rows="8" readonly></textarea>
          </div>

          <div class="story-block">
            <label>Query Activity</label>
            <div class="activity-log" id="activityLog"></div>
          </div>

          <div class="perf-block">
            <div class="perf-title">Query Performance (Proxy)</div>
            <div class="perf-compare">
              <div class="perf-compare-title">Real time per query (naive replay vs VSABrains replay)</div>
              <div class="perf-bars">
                <div class="perf-bar">
                  <div class="perf-bar-label">VSABrains</div>
                  <div class="perf-bar-track">
                    <div class="perf-bar-fill vsa" id="perfBarVsa">
                      <span class="perf-bar-value" id="perfBarVsaValue">—</span>
                    </div>
                  </div>
                </div>
                <div class="perf-bar">
                  <div class="perf-bar-label">Naive List</div>
                  <div class="perf-bar-track">
                    <div class="perf-bar-fill naive" id="perfBarNaive">
                      <span class="perf-bar-value" id="perfBarNaiveValue">—</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="status" id="statusMsg"></div>
          </div>
          <div class="subtab-panel hidden" data-subpanel="cnl">
            <div class="field">
              <label for="frameProfile">Frame Profile (CNL)</label>
              <select id="frameProfile"></select>
            </div>
            <div class="story-block">
              <label for="cnlField">Active CNL Profile</label>
              <textarea id="cnlField" rows="6" readonly></textarea>
            </div>
          </div>
          <div class="subtab-panel hidden" data-subpanel="frames">
            <div class="spaces-note muted">
              Frame film: plays frames in order of activity and draws the step segments where each frame appeared (last 250 steps).
            </div>
            <div class="frames-now" id="framesNow">Idle · no frame playing</div>
            <div class="frames-legend" id="frameLegend"></div>
            <div class="story-block">
              <label for="framesSummary">Frames Summary</label>
              <textarea id="framesSummary" rows="5" readonly></textarea>
            </div>
            <div class="spaces-meta" id="spacesMeta">Facts: 0</div>
            <div class="spaces-note muted">
              Frames are defined by a CNL profile and activated dynamically based on salience.
            </div>
          </div>
        </section>
      </main>
    </div>

    <div class="busy-overlay" id="busyOverlay" aria-live="polite" aria-busy="true">
      <div class="busy-dialog" role="dialog" aria-modal="true" aria-label="Processing request">
        <div class="busy-spinner" aria-hidden="true"></div>
        <div class="busy-text" id="busyMessage">Working…</div>
      </div>
    </div>

    <div class="mismatch-overlay" id="mismatchOverlay" aria-live="polite">
      <div class="mismatch-dialog" role="dialog" aria-modal="true" aria-label="Mismatch detected">
        <div class="mismatch-header">
          <div class="mismatch-title">Mismatch between VSABrains and Naive</div>
          <button class="btn ghost mismatch-close" id="mismatchCloseBtn">Close</button>
        </div>
        <div class="mismatch-meta">
          <span id="mismatchType">Type: —</span>
          <span id="mismatchStep">Step: —</span>
        </div>
        <div class="mismatch-grid">
          <div class="mismatch-col">
            <div class="mismatch-col-title">VSABrains</div>
            <textarea id="mismatchVsa" rows="8" readonly></textarea>
          </div>
          <div class="mismatch-col">
            <div class="mismatch-col-title">Naive</div>
            <textarea id="mismatchNaive" rows="8" readonly></textarea>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="app.js"></script>
  </body>
</html>
